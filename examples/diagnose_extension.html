<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Extension Diagnostic Tool</title>
    <style>
      body {
        font-family: monospace;
        max-width: 900px;
        margin: 40px auto;
        padding: 20px;
        background: #f5f5f5;
      }
      .test-section {
        background: white;
        padding: 20px;
        margin: 20px 0;
        border-radius: 8px;
        border-left: 4px solid #1a73e8;
      }
      .status {
        padding: 10px;
        margin: 10px 0;
        border-radius: 4px;
      }
      .status.success {
        background: #d4edda;
        color: #155724;
      }
      .status.error {
        background: #f8d7da;
        color: #721c24;
      }
      .status.warning {
        background: #fff3cd;
        color: #856404;
      }
      .status.info {
        background: #d1ecf1;
        color: #0c5460;
      }
      button {
        padding: 10px 20px;
        margin: 5px;
        font-size: 14px;
        cursor: pointer;
        background: #1a73e8;
        color: white;
        border: none;
        border-radius: 4px;
      }
      button:hover {
        background: #1557b0;
      }
      pre {
        background: #f8f9fa;
        padding: 10px;
        border-radius: 4px;
        overflow-x: auto;
      }
    </style>
  </head>
  <body>
    <h1>Extension Diagnostic Tool</h1>
    <p>Use this page to diagnose why the extension isn't working.</p>

    <div class="test-section">
      <h2>1. Extension Status Check</h2>
      <button onclick="checkExtension()">Check Extension Status</button>
      <div id="extension-status"></div>
    </div>

    <div class="test-section">
      <h2>2. Test Selection</h2>
      <p>Select this text: <strong>Test formula: $x^2 + y^2 = z^2$</strong></p>
      <p>Then right-click ‚Üí "Copy as Office Format"</p>
      <button onclick="testSelection()">Test Selection Detection</button>
      <div id="selection-status"></div>
    </div>

    <div class="test-section">
      <h2>3. Test Message Sending</h2>
      <button onclick="testMessage()">Send Test Message</button>
      <div id="message-status"></div>
    </div>

    <div class="test-section">
      <h2>4. Console Logs</h2>
      <p>Open browser console (F12) and check for:</p>
      <ul>
        <li>
          <code>[Copy as Office Format Background]</code> - Background script
          logs
        </li>
        <li><code>[Copy as Office Format]</code> - Content script logs</li>
      </ul>
      <button onclick="showConsoleInstructions()">
        Show Console Instructions
      </button>
      <div id="console-instructions"></div>
    </div>

    <script>
      function addStatus(elementId, message, type = "info") {
        const div = document.getElementById(elementId);
        const status = document.createElement("div");
        status.className = `status ${type}`;
        status.innerHTML = message;
        div.appendChild(status);
      }

      function clearStatus(elementId) {
        document.getElementById(elementId).innerHTML = "";
      }

      function checkExtension() {
        clearStatus("extension-status");

        // Check extension marker
        const hasMarker =
          typeof window.__copyOfficeFormatExtension !== "undefined";
        if (hasMarker) {
          const marker = window.__copyOfficeFormatExtension;
          addStatus(
            "extension-status",
            `‚úÖ Extension marker found!<br>
                     Version: ${marker.version || "unknown"}<br>
                     Loaded: ${marker.loaded ? "Yes" : "No"}<br>
                     Ready: ${marker.ready ? "Yes" : "No"}`,
            "success",
          );
        } else {
          addStatus(
            "extension-status",
            "‚ùå Extension marker NOT found!<br>Extension content script is not loaded.",
            "error",
          );
        }

        // Check browser API
        const hasBrowserAPI =
          typeof browser !== "undefined" &&
          typeof browser.runtime !== "undefined";
        if (hasBrowserAPI) {
          addStatus(
            "extension-status",
            "‚úÖ Browser runtime API available",
            "success",
          );
          try {
            const extId = browser.runtime.id;
            addStatus("extension-status", `Extension ID: ${extId}`, "info");
          } catch (e) {
            addStatus(
              "extension-status",
              `‚ö†Ô∏è Could not get extension ID: ${e.message}`,
              "warning",
            );
          }
        } else {
          addStatus(
            "extension-status",
            "‚ùå Browser runtime API NOT available",
            "error",
          );
        }

        // Check context menu (can't directly check, but can verify)
        addStatus(
          "extension-status",
          '‚ÑπÔ∏è To check context menu: Right-click on selected text and look for "Copy as Office Format"',
          "info",
        );
      }

      function testSelection() {
        clearStatus("selection-status");
        const sel = window.getSelection();

        if (!sel || sel.rangeCount === 0) {
          addStatus(
            "selection-status",
            "‚ùå No selection found. Please select some text first.",
            "error",
          );
          return;
        }

        if (sel.isCollapsed) {
          addStatus(
            "selection-status",
            "‚ùå Selection is collapsed (just cursor position). Please select actual text.",
            "error",
          );
          return;
        }

        const text = sel.toString();
        const html = sel.getRangeAt(0).cloneContents();
        const div = document.createElement("div");
        div.appendChild(html);

        addStatus(
          "selection-status",
          `‚úÖ Selection detected!<br>
                 Text length: ${text.length}<br>
                 HTML length: ${div.innerHTML.length}<br>
                 Contains $: ${text.includes("$") ? "Yes" : "No"}<br>
                 Contains $$: ${text.includes("$$") ? "Yes" : "No"}<br>
                 Preview: ${text.substring(0, 100)}${text.length > 100 ? "..." : ""}`,
          "success",
        );
      }

      async function testMessage() {
        clearStatus("message-status");

        if (
          typeof browser === "undefined" ||
          typeof browser.runtime === "undefined"
        ) {
          addStatus(
            "message-status",
            "‚ùå Browser runtime API not available",
            "error",
          );
          return;
        }

        addStatus("message-status", "üì§ Sending test message...", "info");

        try {
          const response = await browser.runtime.sendMessage({
            type: "COPY_OFFICE_FORMAT",
          });
          addStatus(
            "message-status",
            `‚úÖ Message sent successfully!<br>Response: ${JSON.stringify(response)}`,
            "success",
          );
        } catch (err) {
          addStatus(
            "message-status",
            `‚ùå Message send failed!<br>
                     Error: ${err.name}<br>
                     Message: ${err.message}<br>
                     <br>Possible causes:<br>
                     - Content script not loaded<br>
                     - Extension not active on this page<br>
                     - Message listener not registered`,
            "error",
          );
        }
      }

      function showConsoleInstructions() {
        clearStatus("console-instructions");
        addStatus(
          "console-instructions",
          `
                <h3>How to Check Console Logs:</h3>
                <ol>
                    <li><strong>Background Script Console:</strong>
                        <ul>
                            <li>Go to <code>about:debugging</code></li>
                            <li>Find "Copy as Office Format" extension</li>
                            <li>Click "Inspect" button</li>
                            <li>Look for logs starting with <code>[Copy as Office Format Background]</code></li>
                        </ul>
                    </li>
                    <li><strong>Content Script Console:</strong>
                        <ul>
                            <li>Open this page</li>
                            <li>Press F12 to open console</li>
                            <li>Look for logs starting with <code>[Copy as Office Format]</code></li>
                        </ul>
                    </li>
                </ol>
                <h3>What to Look For:</h3>
                <ul>
                    <li>üîµ = Information/start of operation</li>
                    <li>‚úÖ = Success</li>
                    <li>‚ùå = Error</li>
                    <li>‚ö†Ô∏è = Warning</li>
                    <li>üì§ = Sending message</li>
                    <li>üìã = Processing selection</li>
                </ul>
            `,
          "info",
        );
      }

      // Auto-check on load
      window.addEventListener("load", () => {
        setTimeout(() => {
          checkExtension();
        }, 1000);
      });
    </script>
  </body>
</html>
